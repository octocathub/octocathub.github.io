(window.webpackJsonp=window.webpackJsonp||[]).push([[147],{568:function(s,a,t){"use strict";t.r(a);var n=t(13),r=Object(n.a)({},(function(){var s=this,a=s.$createElement,t=s._self._c||a;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h1",{attrs:{id:"mysql-定时备份数据库"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#mysql-定时备份数据库"}},[s._v("#")]),s._v(" MySQL 定时备份数据库")]),s._v(" "),t("p",[s._v("在操作数据过程中，可能会导致数据错误，甚至数据库奔溃，而有效的定时备份能很好地保护数据库。本篇文章主要讲述了几种方法进行 MySQL 定时备份数据库。")]),s._v(" "),t("h2",{attrs:{id:"一-mysqldump命令备份数据"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#一-mysqldump命令备份数据"}},[s._v("#")]),s._v(" 一. mysqldump命令备份数据")]),s._v(" "),t("p",[s._v("在MySQL中提供了命令行导出数据库数据以及文件的一种方便的工具mysqldump,我们可以通过命令行直接实现数据库内容的导出dump,首先我们简单了解一下mysqldump命令用法:")]),s._v(" "),t("p",[s._v("#MySQLdump常用\nmysqldump -u root -p --databases 数据库1 数据库2 > xxx.sql")]),s._v(" "),t("h2",{attrs:{id:"二-mysqldump常用操作示例"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#二-mysqldump常用操作示例"}},[s._v("#")]),s._v(" 二. mysqldump常用操作示例")]),s._v(" "),t("ol",[t("li",[s._v("备份全部数据库的数据和结构")])]),s._v(" "),t("p",[s._v("mysqldump -uroot -p123456 -A > /data/mysqlDump/mydb.sql\n2.备份全部数据库的结构（加 -d 参数）")]),s._v(" "),t("p",[s._v("mysqldump -uroot -p123456 -A -d > /data/mysqlDump/mydb.sql\n3. 备份全部数据库的数据(加 -t 参数)")]),s._v(" "),t("p",[s._v("mysqldump -uroot -p123456 -A -t > /data/mysqlDump/mydb.sql\n4.备份单个数据库的数据和结构(,数据库名mydb)")]),s._v(" "),t("p",[s._v("mysqldump -uroot-p123456 mydb > /data/mysqlDump/mydb.sql\n5. 备份单个数据库的结构")]),s._v(" "),t("p",[s._v("mysqldump -uroot -p123456 mydb -d > /data/mysqlDump/mydb.sql\n6. 备份单个数据库的数据")]),s._v(" "),t("p",[s._v("mysqldump -uroot -p123456 mydb -t > /data/mysqlDump/mydb.sql\n7. 备份多个表的数据和结构（数据，结构的单独备份方法与上同）")]),s._v(" "),t("p",[s._v("mysqldump -uroot -p123456 mydb t1 t2 > /data/mysqlDump/mydb.sql\n8. 一次备份多个数据库")]),s._v(" "),t("p",[s._v("mysqldump -uroot -p123456 --databases db1 db2 > /data/mysqlDump/mydb.sql\n三. 还原 MySQL 备份内容\n有两种方式还原，第一种是在 MySQL 命令行中，第二种是使用 SHELL 行完成还原")]),s._v(" "),t("ol",[t("li",[s._v("在系统命令行中，输入如下实现还原：\nmysql -uroot -p123456 < /data/mysqlDump/mydb.sql")]),s._v(" "),t("li",[s._v("在登录进入mysql系统中,通过source指令找到对应系统中的文件进行还原：")])]),s._v(" "),t("p",[s._v("mysql> source /data/mysqlDump/mydb.sql\n在 Linux中，通常使用BASH脚本对需要执行的内容进行编写，加上定时执行命令crontab实现日志自动化生成。")]),s._v(" "),t("p",[s._v("以下代码功能就是针对mysql进行备份，配合crontab，实现备份的内容为近一个月（31天）内的每天的mysql数据库记录。")]),s._v(" "),t("p",[s._v("编写BASH维护固定数量备份文件")]),s._v(" "),t("p",[s._v("在Linux中，使用vi或者vim编写脚本内容并命名为：mysql_dump_script.sh")]),s._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token shebang important"}},[s._v("#!/bin/bash")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#保存备份个数，备份31天数据")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("number")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("31")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#备份保存路径")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("backup_dir")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/root/mysqlbackup\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#日期")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("dd")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token variable"}},[t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("date")]),s._v(" +%Y-%m-%d-%H-%M-%S"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")])]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#备份工具")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("tool")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("mysqldump\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#用户名")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("username")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("root\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#密码")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("password")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("TankB214\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#将要备份的数据库")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("database_name")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("edoctor\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#如果文件夹不存在则创建")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v(" -d "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$backup_dir")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v("     \n    "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" -p "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$backup_dir")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("fi")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#简单写法 mysqldump -u root -p123456 users > /root/mysqlbackup/users-$filename.sql")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$tool")]),s._v(" -u "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$username")]),s._v(" -p"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$password")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$database_name")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$backup_dir")]),s._v("/"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$database_name")]),s._v("-"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$dd")]),s._v(".sql\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#写创建备份日志")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"create '),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$backup_dir")]),s._v("/"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$database_name")]),s._v("-"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$dd")]),s._v('.dupm"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$backup_dir")]),s._v("/log.txt\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#找出需要删除的备份")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("delfile")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token variable"}},[t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v(" -l -crt $backup_dir/*.sql "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("awk")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'{print "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$9")]),s._v(" }'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("head")]),s._v(" -1"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")])]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#判断现在的备份数量是否大于$number")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("count")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token variable"}},[t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v(" -l -crt $backup_dir/*.sql "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("awk")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'{print "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$9")]),s._v(" }'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("wc")]),s._v(" -l"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")])]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$count")]),s._v(" -gt "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$number")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#删除最早生成的备份，只保留number数量的备份")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("rm")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$delfile")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#写删除文件日志")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"delete '),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$delfile")]),s._v('"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$backup_dir")]),s._v("/log.txt\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("fi")]),s._v("\n")])])]),t("p",[s._v("如上代码主要含义如下：")]),s._v(" "),t("p",[s._v("1.首先设置各项参数，例如number最多需要备份的数目，备份路径，用户名，密码等。")]),s._v(" "),t("p",[s._v("2.执行mysqldump命令保存备份文件，并将操作打印至同目录下的log.txt中标记操作日志。")]),s._v(" "),t("p",[s._v("3.定义需要删除的文件：通过ls命令获取第九列，即文件名列，再通过实现定义操作时间最晚的那个需要删除的文件。")]),s._v(" "),t("p",[s._v("4.定义备份数量：通过ls命令加上")]),s._v(" "),t("p",[s._v("统计以sql结尾的文件的行数。")]),s._v(" "),t("p",[s._v("5.如果文件超出限制大小，就删除最早创建的sql文件")]),s._v(" "),t("p",[s._v("使用crontab定期执行备份脚本\n在 Linux 中，周期执行的任务一般由cron这个守护进程来处理[ps -ef|grep cron]。cron读取一个或多个配置文件，这些配置文件中包含了命令行及其调用时间。\ncron的配置文件称为“crontab”，是“cron table”的简写。")]),s._v(" "),t("h2",{attrs:{id:"cron服务"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#cron服务"}},[s._v("#")]),s._v(" cron服务")]),s._v(" "),t("p",[s._v("cron是一个 Liunx 下 的定时执行工具，可以在无需人工干预的情况下运行作业。\nservice crond start    //启动服务\nservice crond stop     //关闭服务\nservice crond restart  //重启服务\nservice crond reload   //重新载入配置\nservice crond status   //查看服务状态\ncrontab语法\ncrontab命令用于安装、删除或者列出用于驱动cron后台进程的表格。用户把需要执行的命令序列放到crontab文件中以获得执行。每个用户都可以有自己的crontab文件。/var/spool/cron下的crontab文件不可以直接创建或者直接修改。该crontab文件是通过crontab命令创建的。")]),s._v(" "),t("p",[s._v("在crontab文件中如何输入需要执行的命令和时间。该文件中每行都包括六个域，其中前五个域是指定命令被执行的时间，最后一个域是要被执行的命令。\n每个域之间使用空格或者制表符分隔。")]),s._v(" "),t("p",[s._v("格式如下：\nminute hour day-of-month month-of-year day-of-week commands\n合法值 00-59 00-23 01-31 01-12 0-6 (0 is sunday)")]),s._v(" "),t("p",[s._v('除了数字还有几个个特殊的符号就是"*"、"/"和"-"、","，*代表所有的取值范围内的数字，"/"代表每的意思,"/5"表示每5个单位，"-"代表从某个数字到某个数字,","分开几个离散的数字。')]),s._v(" "),t("p",[s._v("-l 在标准输出上显示当前的crontab。\n-r 删除当前的crontab文件。\n-e 使用VISUAL或者EDITOR环境变量所指的编辑器编辑当前的crontab文件。当结束编辑离开时，编辑后的文件将自动安装。")]),s._v(" "),t("p",[s._v("创建cron脚本")]),s._v(" "),t("p",[s._v('第一步：写cron脚本文件,命名为mysqlRollBack.cron。\n15,30,45,59 * * * * echo "xgmtest....." >> xgmtest.txt  表示，每隔15分钟，执行打印一次命令\n第二步：添加定时任务。执行命令 “crontab crontest.cron”。搞定\n第三步："crontab -l" 查看定时任务是否成功或者检测/var/spool/cron下是否生成对应cron脚本')]),s._v(" "),t("p",[s._v("注意：这操作是直接替换该用户下的crontab，而不是新增")]),s._v(" "),t("p",[s._v("定期执行编写的定时任务脚本（记得先给shell脚本执行权限）")]),s._v(" "),t("p",[s._v("0 2 * * * /root/mysql_backup_script.sh\n随后使用crontab命令定期指令编写的定时脚本")]),s._v(" "),t("p",[s._v("crontab mysqlRollback.cron\n再通过命令检查定时任务是否已创建：")]),s._v(" "),t("p",[s._v("附 crontab 的使用示例：")]),s._v(" "),t("ol",[t("li",[s._v("每天早上6点")])]),s._v(" "),t("p",[s._v('0 6 * * * echo "Good morning." >> /tmp/test.txt //注意单纯echo，从屏幕上看不到任何输出，因为cron把任何输出都email到root的信箱了。\n2. 每两个小时')]),s._v(" "),t("p",[s._v('0 */2 * * * echo "Have a break now." >> /tmp/test.txt\n3. 晚上11点到早上8点之间每两个小时和早上八点')]),s._v(" "),t("p",[s._v('0 23-7/2，8 * * * echo "Have a good dream" >> /tmp/test.txt\n4. 每个月的4号和每个礼拜的礼拜一到礼拜三的早上11点')]),s._v(" "),t("p",[s._v("0 11 4 * 1-3 command line\n5.1 月 1 日早上 4 点")]),s._v(" "),t("p",[s._v("0 4 1 1 * command line SHELL=/bin/bash PATH=/sbin:/bin:/usr/sbin:/usr/bin MAILTO=root //如果出现错误，或者有数据输出，数据作为邮件发给这个帐号 HOME=/\n6. 每小时执行/etc/cron.hourly内的脚本\n01 * * * * root run-parts /etc/cron.hourly\n7. 每天执行/etc/cron.daily内的脚本")]),s._v(" "),t("p",[s._v("02 4 * * * root run-parts /etc/cron.daily\n8. 每星期执行/etc/cron.weekly内的脚本")]),s._v(" "),t("p",[s._v("22 4 * * 0 root run-parts /etc/cron.weekly\n9. 每月去执行/etc/cron.monthly内的脚本")]),s._v(" "),t("p",[s._v('42 4 1 * * root run-parts /etc/cron.monthly\n注意: "run-parts" 这个参数了，如果去掉这个参数的话，后面就可以写要运行的某个脚本名，而不是文件夹名。')]),s._v(" "),t("ol",{attrs:{start:"10"}},[t("li",[s._v("每天的下午4点、5点、6点的5 min、15 min、25 min、35 min、45 min、55 min时执行命令。")])]),s._v(" "),t("p",[s._v("5，15，25，35，45，55 16，17，18 * * * command\n11. 每周一，三，五的下午3：00系统进入维护状态，重新启动系统。")]),s._v(" "),t("p",[s._v("00 15 * * 1，3，5 shutdown -r +5\n12. 每小时的10分，40分执行用户目录下的innd/bbslin这个指令：")]),s._v(" "),t("p",[s._v("10，40 * * * * innd/bbslink\n13. 每小时的1分执行用户目录下的bin/account这个指令：")]),s._v(" "),t("p",[s._v("以下是我的测试每分钟的截图效果，其对应代码如下：")]),s._v(" "),t("ul",[t("li",[t("ul",[t("li",[t("ul",[t("li",[t("ul",[t("li",[t("ul",[t("li",[s._v("/root/mysql_backup_script.sh")])])])])])])])])])]),s._v(" "),t("p",[s._v("参考： "),t("a",{attrs:{href:"https://mp.weixin.qq.com/s/sevCZ6_1dfP3qSLAIdAJaQ",target:"_blank",rel:"noopener noreferrer"}},[s._v("https://mp.weixin.qq.com/s/sevCZ6_1dfP3qSLAIdAJaQ"),t("OutboundLink")],1)])])}),[],!1,null,null,null);a.default=r.exports}}]);