(window.webpackJsonp=window.webpackJsonp||[]).push([[144],{563:function(s,t,a){"use strict";a.r(t);var n=a(13),e=Object(n.a)({},(function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"nginx-负载均衡"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#nginx-负载均衡"}},[s._v("#")]),s._v(" nginx-负载均衡")]),s._v(" "),a("h2",{attrs:{id:"负载均衡目的"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#负载均衡目的"}},[s._v("#")]),s._v(" 负载均衡目的")]),s._v(" "),a("p",[s._v("将前端超高并发访问转发至后端多台服务器进行处理，解决单个节点压力过大，造成Web服务响应过慢，严重的情况下导致服务瘫痪，无法正常提供服务的问题。")]),s._v(" "),a("h2",{attrs:{id:"工作原理"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#工作原理"}},[s._v("#")]),s._v(" 工作原理")]),s._v(" "),a("p",[s._v("负载均衡分为四层负载均衡和七层负载均衡。")]),s._v(" "),a("p",[s._v("四层负载均衡是工作在七层协议的第四层-传输层，主要工作是转发。")]),s._v(" "),a("p",[s._v("它在接收到客户端的流量以后通过修改数据包的地址信息（目标地址和端口）将流量转发到应用服务器。")]),s._v(" "),a("p",[s._v("七层负载均衡是工作在七层协议的第七层-应用层，主要工作是代理。")]),s._v(" "),a("p",[s._v("它首先会与客户端建立一条完整的连接并将应用层的请求流量解析出来，再按照调度算法选择一个应用服务器，并与应用服务器建立另外一条连接将请求发送过去。")]),s._v(" "),a("p",[s._v("实例")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("前端服务器：192.168.1.6\n后端服务器1：192.168.1.5\n后端服务器2：192.168.1.7\n\n这里后端服务器也可以通过配置虚拟主机实现。\n")])])]),a("p",[s._v("配置：\n前端服务器主要配置upstream和proxy_pass：")]),s._v(" "),a("p",[s._v("upstream 主要是配置均衡池和调度方法。")]),s._v(" "),a("p",[s._v("proxy_pass 主要是配置代理服务器ip或服务器组的名字")]),s._v(" "),a("p",[s._v("proxy_set_header 主要是配置转发给后端服务器的Host和前端客户端真实ip。")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#在http指令块下配置upstream指令块")]),s._v("\n\n    upstream web "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        server "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.5"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        server "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.7"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#在location指令块配置proxy_pass ")]),s._v("\n    server "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        listen       "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        server_name  localhost"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        location /  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            proxy_pass http://web"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n            proxy_next_upstream  error http_404 http_502"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n            proxy_set_header Host "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$host")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n            proxy_set_header X-Real-IP "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$remote_addr")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# proxy_next_upstream  error http_404 http_502;")]),s._v("\n通过这个指令，可以处理当后端服务返回404等报错时，\n直接将请求转发给其他服务器，而不是把报错信息返回客户端。\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# proxy_set_header Host $host; ")]),s._v("\n通过这个指令，把客户端请求的host，转发给后端，\n否则，后端接收到的请求头Host会是web，可能会导致报错误的请求头。\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# proxy_set_header X-Real-IP $remote_addr")]),s._v("\n通过这个指令，把客户端的IP转发给后端服务器，在后端服务器的日志格式中，\n添加"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$http_x_real_ip")]),s._v("即可获取原始客户端的IP了。\n")])])]),a("h2",{attrs:{id:"均衡方式"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#均衡方式"}},[s._v("#")]),s._v(" 均衡方式")]),s._v(" "),a("ol",[a("li",[s._v("轮询")])]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("upstream web "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    server "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.5"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    server "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.7"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])])]),a("p",[s._v("访问前端IP：")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@192 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# while true;do curl 192.168.1.6;sleep 2;done")]),s._v("\nthis is "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.5")]),s._v("  page\n                       this is "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.7")]),s._v("  page\nthis is "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.5")]),s._v("  page\n                       this is "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.7")]),s._v("  page\n                       \n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#可以看到后端服务器，非常平均的处理请求。")]),s._v("\n")])])]),a("ol",{attrs:{start:"2"}},[a("li",[s._v("轮询加权重")])]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("upstream web "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        server "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.5 "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("weight")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        server "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.7 "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("weight")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])])]),a("p",[s._v("访问前端IP：")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@192 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# while true;do curl 192.168.1.6;sleep 1;done")]),s._v("\nthis is "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.5")]),s._v("  page\nthis is "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.5")]),s._v("  page\nthis is "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.5")]),s._v("  page\n                       this is "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.7")]),s._v("  page\nthis is "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.5")]),s._v("  page\nthis is "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.5")]),s._v("  page\nthis is "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.5")]),s._v("  page\n                       this is "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.7")]),s._v("  page\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#后端服务，根据权重比例处理请求，适用于服务器性能不均的环境。")]),s._v("\n")])])]),a("ol",{attrs:{start:"3"}},[a("li",[s._v("轮询+权重+最大连接错误次数\n错误的连接由proxy_next_upstream， fastcgi_next_upstream等指令决定，且默认情况下，后端某台服务器出现故障了，nginx会自动将请求再次转发给其他正常的服务器（因为默认 proxy_next_upstream=error timeout）。")])]),s._v(" "),a("p",[s._v("所以即使我们没有配这个参数，nginx也可以帮我们处理error和timeout的相应，但是没法处理404等报错。")]),s._v(" "),a("p",[s._v("为了看清楚本质，我们先将proxy_next_upstream设置为off，也就是不将失败的请求转发给其他正常服务器，这样我们可以看到请求失败的结果。")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("upstream web "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        server "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.5 "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("weight")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("max_fails")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("fail_timeout")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("9s"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#先将1.5这台nginx关了。")]),s._v("\n        server "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.7 "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("weight")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n       \nserver "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        listen       "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        server_name  localhost"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        location / "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            proxy_pass http://web"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#proxy_next_upstream  error http_404 http_502;")]),s._v("\n            proxy_next_upstream off"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" \n            proxy_set_header Host "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$host")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n            proxy_set_header X-Real-IP "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$remote_addr")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 在这里，我们将超时时间设置为9s，最多尝试3次，")]),s._v("\n这里要注意，尝试3次，依然遵循轮询的规则，并不是一个请求，连接3次，\n而是轮询三次，有3次处理请求的机会。\n")])])]),a("p",[s._v("访问前端IP：")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@192 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# while true;do curl -I 192.168.1.6 2>/dev/null|grep HTTP/1.1 ;sleep 3;done")]),s._v("\nHTTP/1.1 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("502")]),s._v(" Bad Gateway\nHTTP/1.1 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("200")]),s._v(" OK\nHTTP/1.1 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("502")]),s._v(" Bad Gateway\nHTTP/1.1 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("200")]),s._v(" OK\nHTTP/1.1 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("502")]),s._v(" Bad Gateway\nHTTP/1.1 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("200")]),s._v(" OK\nHTTP/1.1 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("200")]),s._v(" OK\nHTTP/1.1 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("200")]),s._v(" OK\nHTTP/1.1 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("200")]),s._v(" OK\nHTTP/1.1 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("502")]),s._v(" Bad Gateway\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 我们设置的超时时间为9s，我们是每3s请求一次。")]),s._v("\n我们可以看到后端一台服务器挂了后，请求没有直接转发给正常的服务器，\n而是直接返回了502。尝试三次后，等待9s，才开始再次尝试（最后一个502）。\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#要注意，第二行的200响应，并不是客户端第一次的请求的响应码，而是客户端第二次新的请求。")]),s._v("\n")])])]),a("p",[s._v("把proxy_next_upstream开启，再来访问看结果：")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("upstream web "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        server "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.5 "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("weight")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("max_fails")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("fail_timeout")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("9s"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#先将1.5这台nginx关了。")]),s._v("\n        server "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.7 "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("weight")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n        \nserver "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        listen       "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        server_name  localhost"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        location / "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            proxy_pass http://web"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n            proxy_next_upstream  error http_404 http_502"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#proxy_next_upstream off; ")]),s._v("\n            proxy_set_header Host "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$host")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n            proxy_set_header X-Real-IP "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$remote_addr")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])])]),a("p",[s._v("访问前端IP：")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@192 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# while true;do curl -I 192.168.1.6 2>/dev/null|grep HTTP/1.1 ;sleep 3;done")]),s._v("\nHTTP/1.1 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("200")]),s._v(" OK\nHTTP/1.1 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("200")]),s._v(" OK\nHTTP/1.1 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("200")]),s._v(" OK\nHTTP/1.1 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("200")]),s._v(" OK\nHTTP/1.1 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("200")]),s._v(" OK\nHTTP/1.1 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("200")]),s._v(" OK\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#可以看到现在没有502报错，请求都处理了。因为错误的响应码被proxy_next_upstream 获取，这次请求被转发给下一个正常的服务器了。")]),s._v("\n")])])]),a("p",[s._v("所以看到都是200，但是你应该清楚，哪个200是响应的上个服务器没有处理请求，哪个200是正常的响应。\n4. ip_hash")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("upstream web "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        ip_hash"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        server "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.5 "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("weight")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("max_fails")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("fail_timeout")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("9s"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        server "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.7 "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("weight")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n        \nserver "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        listen       "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        server_name  localhost"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        location / "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            proxy_pass http://web"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n            proxy_next_upstream  error http_404 http_502"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#proxy_next_upstream off; ")]),s._v("\n            proxy_set_header Host "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$host")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n            proxy_set_header X-Real-IP "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$remote_addr")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])])]),a("p",[s._v("访问前端IP：")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@192 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# while true;do curl 192.168.1.6;sleep 2;done")]),s._v("\nthis is "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.5")]),s._v("  page\nthis is "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.5")]),s._v("  page\nthis is "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.5")]),s._v("  page\n^C\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@192 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# curl 192.168.1.7")]),s._v("\n                       this is "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.7")]),s._v("  page\n                       \n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#可以看到1.7的服务是正常的，但是却不转发给1.7了，请求固定在了1.5的服务器上。")]),s._v("\n")])])]),a("p",[s._v("在使用负载均衡的时候会遇到会话保持的问题,常用的方法有:")]),s._v(" "),a("p",[s._v("a、ip hash，根据客户端的IP，将请求分配到不同的服务器上;")]),s._v(" "),a("p",[s._v("b、cookie，服务器给客户端下发一个cookie，具有特定cookie的请求会分配给它的发布者。")]),s._v(" "),a("p",[s._v("注意:cookie需要浏览器支持,且有时候会泄露数据。")])])}),[],!1,null,null,null);t.default=e.exports}}]);