(window.webpackJsonp=window.webpackJsonp||[]).push([[191],{623:function(s,t,a){"use strict";a.r(t);var r=a(13),e=Object(r.a)({},(function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"数据库事务"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#数据库事务"}},[s._v("#")]),s._v(" 数据库事务")]),s._v(" "),a("blockquote",[a("p",[s._v("重要")])]),s._v(" "),a("blockquote",[a("p",[s._v("来自马哥Linux")])]),s._v(" "),a("h2",{attrs:{id:"事务"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#事务"}},[s._v("#")]),s._v(" 事务")]),s._v(" "),a("p",[s._v("一组原子性的sql查询，或者说一个独立的工作单元。")]),s._v(" "),a("p",[s._v("ACID：")]),s._v(" "),a("ul",[a("li",[s._v("A： atomicity, 原子性：整个事务中的所有操作要么全部成功执行，要么全部失败后回滚。")])]),s._v(" "),a("blockquote",[a("p",[s._v("如何回滚？通过撤销日志，可以实现回滚操作。还有重做日志，可以把以前的操作重新运行一次。")])]),s._v(" "),a("ul",[a("li",[s._v("C: consistency,一致性：数据库总是从一个一致性状态转换为另一个一致性操作。")]),s._v(" "),a("li",[s._v("I: Isolation，隔离性：一个事物所做出的操作在提交之前，是不能为其他所见。（隔离级别就在保证隔离性）隔离有多种隔离级别。\n隔离级别越低，并发性越高，数据安全性越低。事务的隔离会极大的带来系统的开销。")]),s._v(" "),a("li",[s._v("D: durability: 持久性：一旦事务提交，其所做的修改会永久保存于数据库中。")])]),s._v(" "),a("p",[s._v("事务日志：")]),s._v(" "),a("ul",[a("li",[s._v("redolog")]),s._v(" "),a("li",[s._v("undolog")])]),s._v(" "),a("p",[s._v("使用事务：")]),s._v(" "),a("ol",[a("li",[s._v("启动事务： start transaction")]),s._v(" "),a("li",[s._v("运行sql语句")]),s._v(" "),a("li",[s._v("结束事务：\n"),a("ul",[a("li",[s._v("commit ： 提交")]),s._v(" "),a("li",[s._v("rollback ： 回滚\n注意： 只有事务性存储引擎方能支持此类操作。")])])])]),s._v(" "),a("div",{staticClass:"language-sql extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("sql")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SHOW")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("GLOBAL")]),s._v(" VARIABLES "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("LIKE")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'%auto%'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("----------------------------------------------+-------+")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" Variable_name                                "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("Value")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("----------------------------------------------+-------+")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" auto_generate_certs                          "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ON")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" auto_increment_increment                     "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("     "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" auto_increment_offset                        "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("     "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" autocommit                                   "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ON")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" automatic_sp_privileges                      "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ON")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" caching_sha2_password_auto_generate_rsa_keys "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ON")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" innodb_autoextend_increment                  "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" innodb_autoinc_lock_mode                     "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("     "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" innodb_stats_auto_recalc                     "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ON")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" sha256_password_auto_generate_rsa_keys       "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ON")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" sql_auto_is_null                             "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("OFF")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("----------------------------------------------+-------+")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("rows")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("in")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("set")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.24")]),s._v(" sec"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n")])])]),a("p",[s._v("全局参数：autocommit 自动提交。也就是每一条语句都会自动提交事务。\n自动提交会相当影响性能的。")]),s._v(" "),a("p",[s._v("建议： 显式请求和提交事务，而不要使用“自动提交”功能。因为每个提交都会引起磁盘IO操作。\n这样会使数据库服务器频繁的进行io操作。降低系统性能。")]),s._v(" "),a("p",[s._v("会话级别关闭自动提交：")]),s._v(" "),a("div",{staticClass:"language-sql extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SET")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SESSION")]),s._v(" autocommit "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" \n")])])]),a("p",[s._v("事务支持：savepoint[事务保存点]")]),s._v(" "),a("p",[s._v("语法：")]),s._v(" "),a("div",{staticClass:"language-sql extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("savepoint")]),s._v(" identifier\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("rollback")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("work")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("to")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("savepoint")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" identifier\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("release")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("savepoint")]),s._v(" identifier  \n")])])]),a("p",[s._v("事务隔离级别：")]),s._v(" "),a("blockquote",[a("p",[s._v("锁有粒度，粒度越精细，并发性越好，但是带来的额外开销越大。同样的，事务需要隔离，但是隔离做的如果过于严格，任何一个事务都有可能会阻塞其他访问到同一个资源的事物。所以为了避免事务过多的影响其并发性，所以对事务隔离的等级做了定义，这也就是隔离级别。")])]),s._v(" "),a("ul",[a("li",[s._v("READ UNCOMMITED(读未提交)")]),s._v(" "),a("li",[s._v("READ COMMITED(读已提交)")]),s._v(" "),a("li",[s._v("REPEATABLE READ(可重复读)")]),s._v(" "),a("li",[s._v("SERIALIZABLE(串行化) 并发能力最低，安全性最高")])]),s._v(" "),a("p",[s._v("隔离级别越低，随之产生的问题越大。")]),s._v(" "),a("p",[s._v("可能存在的问题：")]),s._v(" "),a("ul",[a("li",[s._v("脏读： 读取到别人未提交的数据。")]),s._v(" "),a("li",[s._v("不可重复读： 两次读取到的数据是不一样的。")]),s._v(" "),a("li",[s._v("幻读： 对方已提交")]),s._v(" "),a("li",[s._v("加锁读： 加了锁，别人都读取不到了。")])]),s._v(" "),a("div",{staticClass:"language-sql extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("show")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("global")]),s._v(" variables "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("like")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'%isola%'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-----------------------+-----------------+")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" Variable_name         "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("Value")]),s._v("           "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-----------------------+-----------------+")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" transaction_isolation "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("REPEATABLE")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("READ")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-----------------------+-----------------+")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("row")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("in")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("set")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.01")]),s._v(" sec"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])])]),a("p",[s._v("默认为 可重复读 级别，可在session级别进行修改。")]),s._v(" "),a("div",{staticClass:"language-sql extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("set")]),s._v(" transaction_isolation "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'READ-UNCOMMITED'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])])]),a("p",[s._v("死锁：\n两个或多个事务在同一资源相互占用，并请求锁定对方占用的资源的状态。")]),s._v(" "),a("p",[s._v("MVCC（InnoDB引擎）: 多版本并发控制。")]),s._v(" "),a("p",[s._v("事务日志：\n随机IO和离散IO操作会引起很大的性能开销。\n事务日志的写入类型为“追加”，因此其操作为“顺序IO”，此日志通常被称为“预写式日志(write ahead logging)”。")]),s._v(" "),a("p",[s._v("不要使用混合的存储引擎，因为有些支持事务，有些不支持事务。")]),s._v(" "),a("blockquote",[a("p",[s._v("https://zhuanlan.zhihu.com/p/76743929")])]),s._v(" "),a("p",[a("a",{attrs:{href:"https://mp.weixin.qq.com/s/F1nmUKHZUNp2aWnUtNQ0lw",target:"_blank",rel:"noopener noreferrer"}},[s._v("https://mp.weixin.qq.com/s/F1nmUKHZUNp2aWnUtNQ0lw"),a("OutboundLink")],1)])])}),[],!1,null,null,null);t.default=e.exports}}]);